{% extends "BusetaTallerBundle::layout.html.twig" %}

{% form_theme form.tarea_adicional 'BusetaTallerBundle:Widgets:collection_tareas_adicionales.html.twig' %}

{% block nombre_menu_superior %}

    {% block stylesheets %}
        {{ parent() }}

        {#<link rel="stylesheet" href="{{ asset('vendors/datetime/css/datepicker.css') }}" media="screen">
        <link rel="stylesheet" href="{{ asset('vendors/datetime/css/datepicker3.css') }}" media="screen">#}

        <link rel="stylesheet" href="{{ asset('vendors/timepicker_bootstrap/css/bootstrap-datetimepicker.min.css') }}" media="screen">



    {% endblock %}
{% endblock %}

{% block titulo_encabezado %}
    Adicionar Orden de Trabajo
{% endblock %}

{% block area_trabajo %}

    <form action="{{ path('ordentrabajo_create') }}" method="post" {{ form_enctype(form) }}>

    {{ form_errors(form) }}

    <div class="row show-grid">
        <div class="col-md-4">
            {{ form_row(form.numero) }}
        </div>

        <div class="col-md-4">
            {{ form_row(form.realizada_por) }}
        </div>

        <div class="col-md-4">
            {{ form_row(form.ayudante) }}
        </div>
    </div>

    <div class="row show-grid">
        <div class="col-md-4">
            {{ form_row(form.autobus) }}
        </div>

        <div class="col-md-4">
            {{ form_row(form.fecha_inicio) }}
        </div>

        <div class="col-md-4">
            {{ form_row(form.fecha_final) }}
        </div>

    </div>

    <div class="row show-grid">
        <div class="col-md-4">
            {{ form_row(form.diagnostico) }}
        </div>

        <div class="col-md-4">
            {{ form_row(form.prioridad) }}
        </div>

    </div>

    <div class="row show-grid">
        <div class="col-md-12">
            {{ form_row(form.observaciones) }}
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            {{ form_row(form.tarea_adicional) }}
        </div>
    </div>


    <div class="row show-grid">
        <div class="col-md-4">
            <div class="btn-group" style="padding-bottom: 8px;">
                <a data-toggle="modal" data-target="#newLinea" class="btn btn-primary" href="#"><i class="fa fa-plus-circle"></i> Adicionar tarea adicional</a>
            </div>
        </div>
    </div>

    <div class="row show-grid">
        <div class="panel panel-default">
            <div class="panel-body">
                <h4>Resumen de Orden de Trabajo:</h4>

                <div class="col-md-4">
                    {{ form_row(form.duracion_dias) }}
                </div>

                <div class="col-md-4">
                    {{ form_row(form.duracion_horas_laboradas) }}
                </div>
            </div>
        </div>
    </div>

    <div class="row show-grid">
        <div class="col-md-4">
            {{ form_row(form.revisado) }}
        </div>

        <div class="col-md-4">
            {{ form_row(form.aprobado) }}
        </div>
    </div>

    <div class="row show-grid">
        <div class="col-md-4">
            <input class="btn btn-primary" style="height: 34px" type="submit" value="Aceptar">
            <div class="btn-group">
                <a class="btn btn-primary" href="{{ path('ordentrabajo') }}"> Cancelar</a>
            </div>
        </div>
    </div>

    {{ form_rest(form) }}
</form>

    <!-- Modal -->
    <div class="modal fade" id="newLinea" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="width: 850px;">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title" id="myModalLabel">Datos de nueva tarea adicional</h3>
                </div>
                <div class="modal-body" style="width: 800px;">
                    <form action="{{ path('tarea_adicional_orden_trabajo_create') }}" method="post" {{ form_enctype(tarea_adicional) }}>
                        <div class="row show-grid">
                            <div class="col-md-4">
                                {{ form_row(tarea_adicional.grupo) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(tarea_adicional.subgrupo) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(tarea_adicional.garantias_tareas) }}
                            </div>
                        </div>

                        <div class="row show-grid">
                            <div class="col-md-4">
                                {{ form_row(tarea_adicional.fecha_estimada) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(tarea_adicional.hora_inicio) }}
                            </div>
                            <div class="col-md-4">
                                {{ form_row(tarea_adicional.hora_final) }}
                            </div>
                        </div>

                        <div class="row show-grid">
                            <div class="col-md-12">
                                {{ form_row(tarea_adicional.tarea) }}
                            </div>
                            <div class="col-md-12">
                                {{ form_row(tarea_adicional.horas_laboradas) }}
                            </div>
                        </div>

                        <div class="row show-grid">
                            <div class="col-md-12">
                                {{ form_row(tarea_adicional.descripcion) }}
                            </div>
                        </div>
                </div>
                <div class="modal-footer">
                    <a data-dismiss="modal" class="btn btn-primary add_tag_link" style="margin: 0px 0px 20px 20px;" href="#"><span class="fa fa-plus-circle">Adicionar</span></a>

                </div>
                {{ form_rest(tarea_adicional) }}
                </form>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

{% endblock %}

{% block contenido %}

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {#<script src="{{ asset('vendors/datetime/js/bootstrap-datepicker.js') }}"></script>#}
    {#<script src="{{ asset('vendors/datetime/js/locales/bootstrap-datepicker.es.js') }}"></script>#}

    <script src="{{ asset('vendors/funciones_datetime_new.js') }}"></script>

    <script src="{{ asset('vendors/timepicker_bootstrap/jquery-2.1.1.min.js') }}"></script>
    <script src="{{ asset('vendors/timepicker_bootstrap/bootstrap.min.js') }}"></script>
    <script src="{{ asset('vendors/timepicker_bootstrap/moment.js') }}"></script>
    <script src="{{ asset('vendors/timepicker_bootstrap/bootstrap-datetimepicker.js') }}"></script>
    <script src="{{ asset('vendors/timepicker_bootstrap/ru.js') }}"></script>

    <script type="text/javascript">
        var collectionHolder = $('div#buseta_tallerbundle_ordentrabajo_tarea_adicional');
        var $addTagLink = $('a.add_tag_link');

        jQuery(document).ready(function() {
            $('#buseta_tallerbundle_ordentrabajo_fecha_inicio').datetimepicker({
                'pickTime' : false,
                'format': 'DD/MM/YYYY',
                'formatSubmit': 'DD/MM/YYYY'
            });

            var fecha_inicio = $('#buseta_tallerbundle_ordentrabajo_fecha_inicio').val();
            $('input:hidden[name^="buseta_tallerbundle_ordentrabajo[fecha_inicio]_submit"]').val(fecha_inicio);

            $('#buseta_tallerbundle_ordentrabajo_fecha_final').datetimepicker({
                'pickTime' : false,
                'format': 'DD/MM/YYYY',
                'formatSubmit': 'DD/MM/YYYY'
            });

            var fecha_final = $('#buseta_tallerbundle_ordentrabajo_fecha_final').val();
            $('input:hidden[name^="buseta_tallerbundle_ordentrabajo[fecha_final]_submit"]').val(fecha_final);

            $("#buseta_tallerbundle_ordentrabajo_fecha_inicio").on("dp.change",function (e) {
                $('#buseta_tallerbundle_ordentrabajo_fecha_final').data("DateTimePicker").setMinDate(e.date);
            });
            $("#buseta_tallerbundle_ordentrabajo_fecha_final").on("dp.change",function (e) {
                $('#buseta_tallerbundle_ordentrabajo_fecha_inicio').data("DateTimePicker").setMaxDate(e.date);
            });

            $("#buseta_tallerbundle_ordentrabajo_fecha_final").change(function(){
                var $fecha_inicio = $("#buseta_tallerbundle_ordentrabajo_fecha_inicio").val();
                var $fecha_final = $("#buseta_tallerbundle_ordentrabajo_fecha_final").val();

                var aFecha1 = $fecha_inicio.split('/');
                var aFecha2 = $fecha_final.split('/');
                var fFecha1 = Date.UTC(aFecha1[2],aFecha1[1]-1,aFecha1[0]);
                var fFecha2 = Date.UTC(aFecha2[2],aFecha2[1]-1,aFecha2[0]);
                var dif = fFecha2 - fFecha1;
                var dias = Math.floor(dif / (1000 * 60 * 60 * 24));

                $('#buseta_tallerbundle_ordentrabajo_duracion_dias').val(dias);
            });

            $('#buseta_tallerbundle_tarea_adicional_hora_inicio').datetimepicker({
                'pickDate' : false,
                'format': 'hh:mm A',
                'formatSubmit': 'hh:mm'
            });

            $('#buseta_tallerbundle_tarea_adicional_hora_final').datetimepicker({
                'pickDate' : false,
                'format': 'hh:mm A',
                'formatSubmit': 'hh:mm'
            });

            $("#buseta_tallerbundle_tarea_adicional_hora_inicio").on("dp.change",function (e) {
                $('#buseta_tallerbundle_tarea_adicional_hora_final').data("DateTimePicker").setMinDate(e.date);
            });
            $("#buseta_tallerbundle_tarea_adicional_hora_final").on("dp.change",function (e) {
                $('#buseta_tallerbundle_tarea_adicional_hora_inicio').data("DateTimePicker").setMaxDate(e.date);
            });

            var hora_inicio = $('#buseta_tallerbundle_ordentrabajo_hora_inicio').val();
            $('input:hidden[name^="buseta_tallerbundle_ordentrabajo[hora_inicio]_submit"]').val(hora_inicio);

            var hora_final = $('#buseta_tallerbundle_ordentrabajo_hora_final').val();
            $('input:hidden[name^="buseta_tallerbundle_ordentrabajo[hora_final]_submit"]').val(hora_final);

            $('#buseta_tallerbundle_tarea_adicional_fecha_estimada').datetimepicker({
                'pickTime' : false,
                'format': 'DD/MM/YYYY',
                'formatSubmit': 'DD/MM/YYYY'
            });

            var fecha_estimada = $('#buseta_tallerbundle_ordentrabajo_fecha_estimada').val();
            $('input:hidden[name^="buseta_tallerbundle_ordentrabajo[fecha_estimada]_submit"]').val(fecha_estimada);

            // count the current form inputs we have (e.g. 2), use that as the new
            // index when inserting a new item (e.g. 2)
            collectionHolder.data('index', collectionHolder.find('a.delete_tag_link').length);

            updateDeleteLink();
            updateView();

            function addTagForm(collectionHolder) {
                // Get the data-prototype explained earlier
                var prototype = collectionHolder.data('prototype');

                // get the new index
                var index = collectionHolder.data('index');

                // Replace '__name__' in the prototype's HTML to
                // instead be a number based on how many items we have
                var newForm = prototype.replace(/__name__/g, index);

                // increase the index with one for the next item
                collectionHolder.data('index', index + 1);

                // Display the form in the page in an li, before the "Add a tag" link li
                var $newFormDiv = $('<div></div>').append(newForm);
                collectionHolder.find('#tbody').append($newFormDiv);
                updateDeleteLink();
                updateView();
            }

            function updateDeleteLink(){
                $('a.delete_tag_link').on('click', function(e) {
                    // prevent the link from creating a "#" on the URL
                    e.preventDefault();

                    // remove the li for the tag form
                    $(this).parent().parent().remove();

                    updateView();
                });
            }

            function updateView(){
                counter = collectionHolder.find('a.delete_tag_link').length;
                if(counter == 0){
                    $('div#no-elements-tr').show();
                }else{
                    $('div#no-elements-tr').hide();
                }
            }

            function actualizarHorasLaboradasTotal(){
                //Obtener cada valor de las tareas adicionales y sumarlas a una variable
                var horastotal = 0;

                $('[id^="buseta_tallerbundle_ordentrabajo_tarea_adicional_"][id$="_horas_laboradas"]').each(function(key, value){
                    horastotal += parseInt($(value).val());
                });

                //Actualizar el valor de los dias de todas las tareas adicionales
                $('#buseta_tallerbundle_ordentrabajo_duracion_horas_laboradas').val(horastotal);
            }

            $addTagLink.on('click', function(e) {
                // prevent the link from creating a "#" on the URL
                e.preventDefault();

                var modal = $('#newLinea');

                // captura de valores del modal
                var tareaadicional_grupo     = modal.find('#buseta_tallerbundle_tarea_adicional_grupo');
                var tareaadicional_subgrupo  = modal.find('#buseta_tallerbundle_tarea_adicional_subgrupo');
                var tareaadicional_tarea     = modal.find('#buseta_tallerbundle_tarea_adicional_tarea');
                var tareaadicional_fecha_estimada   = modal.find('#buseta_tallerbundle_tarea_adicional_fecha_estimada');
                var tareaadicional_descripcion     = modal.find('#buseta_tallerbundle_tarea_adicional_descripcion');
                var tareaadicional_hora_inicio     = modal.find('#buseta_tallerbundle_tarea_adicional_hora_inicio');
                var tareaadicional_hora_final      = modal.find('#buseta_tallerbundle_tarea_adicional_hora_final');
                var tareaadicional_garantias_tareas     = modal.find('#buseta_tallerbundle_tarea_adicional_garantias_tareas');

                var data = {
                    grupo_id: $(tareaadicional_grupo).val()
                };

                //Realizar tareas cuando ha finalizado una peticion AJAX (emula comportamiento sincrona)
                //Actualiza los subgrupos a partir de los grupos en el listado de Tareas Adicionales
                $.when(
                        $.ajax({
                            type: 'GET',
                            url: '{{ path("tareamantenimiento_ajax_grupos_subgrupos") }}',
                            data: data
                        })
                        ).done(function(data, textStatus, jqXHR){

                            var values = $.parseJSON(data);

                            var index = collectionHolder.data('index');

                            addTagForm(collectionHolder);

                            dinamicSelects();

                            var $subgrupo_selector = $('select[id="buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_subgrupo"]');

                            $subgrupo_selector.html('<option>---Seleccione un subgrupo---</option>');

                            for (var i=0, total = values.length; i < total; i++) {
                                $subgrupo_selector.append('<option value="' + values[i].id + '">' + values[i].valor + '</option>');
                            }

                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_grupo').val(tareaadicional_grupo.val());
                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_subgrupo').val(tareaadicional_subgrupo.val());
                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_tarea').val(tareaadicional_tarea.val());
                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_fecha_estimada').val(tareaadicional_fecha_estimada.val());
                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_descripcion').val(tareaadicional_descripcion.val());

                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_hora_inicio').val(tareaadicional_hora_inicio.val());
                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_hora_final').val(tareaadicional_hora_final.val());
                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_garantias_tareas').val(tareaadicional_garantias_tareas.val());

                            var valA = $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_hora_inicio').val(tareaadicional_hora_inicio.val());
                            var valB = $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_hora_final').val(tareaadicional_hora_final.val());


                            var t1 = new Date();
                            var t2 = new Date();

                            //HORA-A
                            valA = valA.val().split(":");
                            horaA = valA[0];
                            valA = valA[1].split(" ");
                            minutosA = valA[0];
                            horarioA = valA[1];

                            //HORA-B
                            valB = valB.val().split(":");
                            horaB = valB[0];
                            valB = valB[1].split(" ");
                            minutosB = valB[0];
                            horarioB = valB[1];

                            //Trabajar con "AM" y "PM"
                            horarioA  == 'PM' ? horaA = (12+parseInt(horaA)) : horaA;
                            horarioB  == 'PM' ? horaB = (12+parseInt(horaB)) : horaB;

                            t2.setHours(horaA, minutosA);
                            t1.setHours(horaB, minutosB);

                            //Aquí hago la resta
                            t1.setHours(t1.getHours() - t2.getHours(), t1.getMinutes() - t2.getMinutes(), t1.getSeconds() - t2.getSeconds());
                            horasTotales = (t1.getHours() ? t1.getHours() + (t1.getHours() > 1 ? "" : "") : "");

                            isNaN(parseInt(horasTotales)) ? horasTotales = 0 : horasTotales;

                            horasTotales = parseInt(horasTotales);

                            $('#buseta_tallerbundle_ordentrabajo_tarea_adicional_' + index + '_horas_laboradas').val(horasTotales);

                            actualizarHorasLaboradasTotal();
                        })

                /*Obtener cada valor de las tareas adicionales y sumarlas a una variable*/
            });
        });

        dinamicSelects();

        function dinamicSelects(){
            $('select[id^="buseta_tallerbundle_ordentrabajo_tarea_adicional_"][id$="_grupo"]').change(function(){
                var $selectGroup = $(this);
                console.log($selectGroup);
                alert($selectGroup);
                var data = {
                    grupo_id: $(this).val()
                };

                $.ajax({
                    type: 'GET',
                    url: '{{ path("tareamantenimiento_ajax_grupos_subgrupos") }}',
                    data: data,
                    success: function(data) {
                        var values = $.parseJSON(data);

                        var $subgrupo_selector = $selectGroup.parent().parent().find('select[id^="buseta_tallerbundle_ordentrabajo_tarea_adicional_"][id$="_subgrupo"]');

                        $subgrupo_selector.html('<option>---Seleccione un subgrupo---</option>');

                        for (var i=0, total = values.length; i < total; i++) {
                            $subgrupo_selector.append('<option value="' + values[i].id + '">' + values[i].valor + '</option>');
                        }
                    }
                });
            })
        }

        //$('buseta_tallerbundle_tarea_adicional_hora_inicio').timepicker();

        //Actualiza los subgrupos a partir de los grupos seleccionados con peticiones AJAX
        $('#{{ tarea_adicional.grupo.vars.id }}').change(function(){
            var data = {
                grupo_id: $(this).val()
            };

            $.ajax({
                type: 'GET',
                url: '{{ path("tareamantenimiento_ajax_grupos_subgrupos") }}',
                data: data,
                success: function(data) {
                    var values = $.parseJSON(data);
                    var $subgrupo_selector = $('#{{ tarea_adicional.subgrupo.vars.id }}');

                    $subgrupo_selector.html('<option>---Seleccione un subgrupo---</option>');

                    for (var i=0, total = values.length; i < total; i++) {
                        $subgrupo_selector.append('<option value="' + values[i].id + '">' + values[i].valor + '</option>');
                    }
                }
            });
        });


    </script>

{% endblock javascripts %}