{% extends "BusetaBodegaBundle::layout.html.twig" %}

{% block nombre_menu_superior %}

{% block titulo_encabezado %}
    Adicionar nuevo Tercero
{% endblock %}

{% block area_trabajo %}
    <ul class="nav nav-tabs">
        <li class="active"><a href="#basicos" data-toggle="tab">Tercero</a></li>
        <li><a href="#direcciones" data-toggle="tab">Direcciones</a></li>
        <li><a href="#contactos" data-toggle="tab">Mecanismos de contacto</a></li>
    </ul>

    {# Tab panes #}
    <div class="tab-content" style="padding-top: 20px;">
        <!-- TAB BASICOS-->
        <div class="tab-pane fade in active" id="basicos">
            {% include 'BusetaBodegaBundle:Tercero:form_model.html.twig' with {'form': form} %}
        </div>

        <!-- TAB DIRECCIONES-->
        <div class="tab-pane fade" id="direcciones">

        </div>

        <!-- TAB MECANISMOS DE CONTACTO-->
        <div class="tab-pane fade" id="contactos">

        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

  <script type="text/javascript">
    var collectionHolder = $('table#buseta_bodegabundle_tercero_mecanismoscontacto');
    var $addTagLink = $('a.add_tag_link');
    var $addTagLinkDireccion = $('a.add_tag_link_direccion');

    jQuery(document).ready(function() {
        // count the current form inputs we have (e.g. 2), use that as the new
        // index when inserting a new item (e.g. 2)
        collectionHolder.data('index', collectionHolder.find('a.delete_tag_link').length);

        $addTagLink.on('click', function(e) {
            // prevent the link from creating a "#" on the URL
            e.preventDefault();

            // add a new tag form (see next code block)
            addTagForm(collectionHolder);
        });

        $addTagLinkDireccion.on('click', function(e) {
            // prevent the link from creating a "#" on the URL
            e.preventDefault();

            var modal = $('#newDireccion');

            //captura de valores del modal
            var direccion_modalA = modal.find('#buseta_bodegabundle_direccion_calle');
            var direccion_modalB = modal.find('#buseta_bodegabundle_direccion_numero');
            var direccion_modalC = modal.find('#buseta_bodegabundle_direccion_entre_calles');
            var direccion_modalD = modal.find('#buseta_bodegabundle_direccion_pais');
            var direccion_modalE = modal.find('#buseta_bodegabundle_direccion_subdivision');
            var direccion_modalF = modal.find('#buseta_bodegabundle_direccion_ciudad');

            var textDireccion = direccion_modalA.val()+". "+direccion_modalB.val()+". "+direccion_modalC.val()+". "+direccion_modalD.val()+". "+direccion_modalE.val()+". "+direccion_modalF.val();


            var data = $('form#form_direccion').serialize();
            $.ajax({
                url: Routing.generate('direccion_create'),
                type: 'POST',
                data: data
            })
                    .done(function (response) {
                        var values = $.parseJSON(response);

                        //$('form#form_direccion').replaceWith(values.vista);
                        $('div#newDireccion').modal('hide');
                        $('#buseta_bodegabundle_tercero_direccion').val(textDireccion).prop('readonly','readonly');
                        $('#buseta_bodegabundle_tercero_direccionId').val(values.id);
                    })
                    .fail(function(error){
                        console.error('Ha ocurrido un error');
                        $('form#form_direccion').replaceWith(error.responseText);
                    })
        });

        updateDeleteLink();
        updateView();

        function addTagForm(collectionHolder) {
            // Get the data-prototype explained earlier
            var prototype = collectionHolder.data('prototype');

            // get the new index
            var index = collectionHolder.data('index');

            // Replace '__name__' in the prototype's HTML to
            // instead be a number based on how many items we have
            var newForm = prototype.replace(/__name__/g, index);

            // increase the index with one for the next item
            collectionHolder.data('index', index + 1);

            // Display the form in the page in an li, before the "Add a tag" link li
            var $newFormDiv = $('<tr></tr>').append(newForm);
            collectionHolder.find('tbody').append($newFormDiv);
            updateDeleteLink();
            updateView();
        }

        function updateDeleteLink(){
            $('a.delete_tag_link').on('click', function(e) {
                // prevent the link from creating a "#" on the URL
                e.preventDefault();

                // remove the li for the tag form
                $(this).parent().parent().remove();
                updateView();
            });
        }

        function updateView(){
            counter = collectionHolder.find('a.delete_tag_link').length;
            if(counter == 0){
                $('tr#no-elements-tr').show();
            }else{
                $('tr#no-elements-tr').hide();
            }
        }
    });

  </script>
{% endblock javascripts %}
